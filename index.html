<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>

    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      /* ===== Modal de imagen ===== */
      dialog.bori-modal{
        width:min(960px,96vw);height:min(80vh,720px);
        border:none;border-radius:14px;padding:0;overflow:hidden;
        background:#0b0b15;color:#fff;box-shadow:0 10px 40px rgba(0,0,0,.35)
      }
      .bori-modal__bar{
        display:flex;align-items:center;justify-content:space-between;
        padding:10px 12px;background:#141428;font-family:Poppins,system-ui,sans-serif
      }
      .bori-modal__bar .btn{
        background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px
      }
      .bori-modal__bar .btn.primary{background:#5F2EEA}
      .bori-modal__body{height:calc(100% - 44px);position:relative}

      /* Lienzo */
      .bori-modal__stage{
        display:flex;align-items:center;justify-content:center;
        height:100%;background:#0b0b15;position:relative
      }
      .bori-modal__img{
        max-width:100%;max-height:100%;object-fit:contain;opacity:0;transition:opacity .32s ease
      }
      .bori-modal__img.is-ready{opacity:1}

      /* Caption / Title */
      .bori-modal__caption{
        padding:8px 12px;background:#0f0f1f;color:#cfd2ff;font-size:12px;
        font-family:Poppins,system-ui,sans-serif
      }
      .hidden{display:none !important}

      /* Controles story */
      .bori-nav{
        position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none
      }
      .bori-nav button{
        pointer-events:auto;border:0;border-radius:12px;background:rgba(20,20,40,.6);
        color:#fff;width:42px;height:42px;cursor:pointer;display:grid;place-items:center
      }
      .bori-nav .zone{
        position:absolute;top:0;bottom:0;width:40%;cursor:pointer;pointer-events:auto;background:transparent
      }
      .bori-nav .zone.left{left:0}
      .bori-nav .zone.right{right:0}
      .bori-counter{
        position:absolute;right:12px;bottom:10px;font-size:12px;color:#cfd2ff;background:rgba(20,20,40,.6);
        padding:4px 8px;border-radius:8px
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="app-header">
      <div class="header-left">
        <button id="play-pause-button" class="audio-button" aria-label="Reproducir música"></button>
        <img
          src="https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png"
          alt="Logo de Borí Cano"
          class="header-logo"
        />
      </div>
      <div class="title-container">
        <h1>Borí Cano Chat</h1>
        <p>¡Wepa panita!</p>
      </div>
    </header>

    <!-- Contenedor para karaoke -->
    <div id="lyrics-container"></div>

    <main>
      <!-- ElevenLabs Conversational AI Widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <!-- ===== Client Tools: showImageModal + showStory ===== -->
      <script>
        (function () {
          /* ===== Estado global de story ===== */
          const storyState = {
            active: false,
            frames: [],
            index: 0,
            autoplay: false,
            interval: 4500,
            timer: null
          };

          function clearAutoplay(){
            if (storyState.timer){ clearInterval(storyState.timer); storyState.timer = null; }
          }

          /* ===== Helpers de normalización ===== */
          function normalizeFrames(input){
            try{
              // Si viene como string JSON
              if (typeof input === 'string') input = JSON.parse(input.trim());

              // Si viene anidado { frames: [...] }
              if (input && !Array.isArray(input) && typeof input === 'object' && Array.isArray(input.frames)) {
                input = input.frames;
              }

              // Si viene un solo objeto {url:...}
              if (input && !Array.isArray(input) && typeof input === 'object' && input.url) {
                input = [input];
              }

              // Si viene array de strings → array de objetos {url}
              if (Array.isArray(input) && input.length && typeof input[0] === 'string') {
                input = input.map(u => ({ url: u }));
              }
            } catch (e) { /* ignore parse errors */ }

            // Validación final
            if (!Array.isArray(input)) return null;
            const out = input
              .map(f => (typeof f === 'string' ? { url: f } : f))
              .filter(f => f && typeof f.url === 'string' && /^https?:\/\//.test(f.url));
            return out.length ? out : null;
          }

          /* ===== Modal ===== */
          function ensureImageModal () {
            let dlg = document.getElementById('img-dialog');
            if (dlg) return dlg;

            dlg = document.createElement('dialog');
            dlg.id = 'img-dialog';
            dlg.className = 'bori-modal';
            dlg.setAttribute('aria-modal','true');

            const bar = document.createElement('div');
            bar.className = 'bori-modal__bar';
            bar.innerHTML = `
              <div id="img-title" style="font-weight:700;font-size:14px">Imagen</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <span id="story-counter" class="bori-counter hidden"></span>
                <a id="img-open" class="btn primary" target="_blank" rel="noopener noreferrer">Abrir</a>
                <button id="img-close" class="btn">Cerrar</button>
              </div>
            `;

            const body = document.createElement('div');
            body.className = 'bori-modal__body';
            body.innerHTML = `
              <div class="bori-modal__stage">
                <img id="img-view" class="bori-modal__img" alt="" />
                <div class="bori-nav hidden">
                  <button id="btn-prev" title="Anterior" aria-label="Anterior">&#9664;</button>
                  <button id="btn-next" title="Siguiente" aria-label="Siguiente">&#9654;</button>
                  <div class="zone left" aria-hidden="true"></div>
                  <div class="zone right" aria-hidden="true"></div>
                </div>
              </div>
              <div id="img-caption" class="bori-modal__caption hidden"></div>
            `;

            dlg.appendChild(bar);
            dlg.appendChild(body);
            document.body.appendChild(dlg);

            // Cerrar
            dlg.querySelector('#img-close').addEventListener('click', () => closeImageModal('user'));
            dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); closeImageModal('esc'); });

            // Navegación de story
            const prev = dlg.querySelector('#btn-prev');
            const next = dlg.querySelector('#btn-next');
            const zoneL = dlg.querySelector('.zone.left');
            const zoneR = dlg.querySelector('.zone.right');
            prev.addEventListener('click', prevFrame);
            next.addEventListener('click', nextFrame);
            zoneL.addEventListener('click', prevFrame);
            zoneR.addEventListener('click', nextFrame);

            // Teclado
            dlg.addEventListener('keydown', (ev)=>{
              if (!storyState.active) return;
              if (ev.key === 'ArrowLeft') { ev.preventDefault(); prevFrame(); }
              else if (ev.key === 'ArrowRight' || ev.key === ' ') { ev.preventDefault(); nextFrame(); }
            });

            return dlg;
          }

          function setTitleAndCaption(dlg, title='', caption=''){
            const titleEl = dlg.querySelector('#img-title');
            const capEl = dlg.querySelector('#img-caption');
            titleEl.textContent = title || 'Imagen';
            capEl.textContent = caption || '';
            capEl.classList.toggle('hidden', !caption);
          }

          function setCounter(dlg, index, total){
            const el = dlg.querySelector('#story-counter');
            if (total > 1){
              el.textContent = (index+1) + ' / ' + total;
              el.classList.remove('hidden');
            } else {
              el.classList.add('hidden');
            }
          }

          function setNavVisible(dlg, visible){
            const nav = dlg.querySelector('.bori-nav');
            nav.classList.toggle('hidden', !visible);
          }

          function loadImage(url){
            return new Promise((resolve, reject)=>{
              const im = new Image();
              im.onload = ()=>resolve(url);
              im.onerror = ()=>reject(new Error('image-load-failed'));
              im.src = url;
            });
          }

          function showUrlInModal(dlg, { url, title='', caption='', alt='', fit='contain' } = {}){
            // Pre-carga, luego cross-fade
            const img = dlg.querySelector('#img-view');
            img.classList.remove('is-ready');
            img.style.objectFit = (fit === 'cover' ? 'cover' : 'contain');

            return loadImage(url)
              .then(()=>{
                img.src = url;
                img.alt = alt || title || '';
                dlg.querySelector('#img-open').href = url;
                setTitleAndCaption(dlg, title, caption);
                requestAnimationFrame(()=>img.classList.add('is-ready'));
                return { ok:true, url };
              })
              .catch(()=>{
                // Fallback: logo Borí
                const fallback = 'https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png';
                img.src = fallback;
                img.alt = 'Imagen no disponible';
                setTitleAndCaption(dlg, 'Imagen no disponible', 'No se pudo cargar la imagen solicitada.');
                dlg.querySelector('#img-open').href = url;
                requestAnimationFrame(()=>img.classList.add('is-ready'));
                return { ok:false, error:'image-load-failed', url };
              });
          }

          /* ===== API pública del modal ===== */
          function openImageModal ({ url, title='', caption='', alt='', fit='contain' } = {}) {
            const dlg = ensureImageModal();
            storyState.active = false; // modo single
            clearAutoplay();
            setNavVisible(dlg, false);
            setCounter(dlg, 0, 0);

            if (!dlg.open && typeof dlg.showModal === 'function') dlg.showModal();
            return showUrlInModal(dlg, { url, title, caption, alt, fit });
          }

          /* ===== startStory robusto con normalización y coerción ===== */
          function startStory ({ frames, startIndex=0, autoplay=false, interval=4500 } = {}) {
            const parsedFrames = normalizeFrames(frames);
            if (!parsedFrames) return { ok:false, error:'invalid_frames' };

            // Coerción segura de tipos
            const idx  = Math.max(0, Math.min(parseInt(startIndex,10) || 0, parsedFrames.length-1));
            const auto = (autoplay === true || autoplay === 'true' || autoplay === 1 || autoplay === '1');
            const ms   = Math.max(1000, parseInt(interval,10) || 4500);

            // Estado
            storyState.active   = true;
            storyState.frames   = parsedFrames;
            storyState.index    = idx;
            storyState.autoplay = auto;
            storyState.interval = ms;
            clearAutoplay();

            // Prefetch
            parsedFrames.forEach(f => { if (f?.url) { const _ = new Image(); _.src = f.url; } });

            // UI
            const dlg = ensureImageModal();
            if (!dlg.open && typeof dlg.showModal === 'function') dlg.showModal();
            setNavVisible(dlg, true);
            renderCurrentFrame();

            if (storyState.autoplay){
              storyState.timer = setInterval(()=> nextFrame(), storyState.interval);
            }
            return { ok:true, total: parsedFrames.length };
          }

          function renderCurrentFrame(){
            const dlg = ensureImageModal();
            const f = storyState.frames[storyState.index] || {};
            setCounter(dlg, storyState.index, storyState.frames.length);
            return showUrlInModal(dlg, {
              url: f.url,
              title: f.title || '',
              caption: f.caption || '',
              alt: f.alt || '',
              fit: f.fit || 'contain'
            });
          }

          function nextFrame(){
            if (!storyState.active) return;
            storyState.index = (storyState.index + 1);
            if (storyState.index >= storyState.frames.length){
              // Llega al final: detiene autoplay y se queda en el último frame
              storyState.index = storyState.frames.length - 1;
              clearAutoplay();
              return;
            }
            renderCurrentFrame();
          }

          function prevFrame(){
            if (!storyState.active) return;
            storyState.index = Math.max(0, storyState.index - 1);
            renderCurrentFrame();
          }

          function closeImageModal(reason='close'){
            clearAutoplay();
            const dlg = document.getElementById('img-dialog');
            if (dlg?.open) dlg.close(reason);
            storyState.active = false;
            return { ok:true, reason };
          }

          /* ===== Registro de Client Tools ===== */
          const safeTools = {
            // Soporta ambos nombres por si el tool en ElevenLabs tiene case distinto
            showImageModal: ({ url, title, caption, alt, fit }) => openImageModal({ url, title, caption, alt, fit }),
            showimageModal: ({ url, title, caption, alt, fit }) => openImageModal({ url, title, caption, alt, fit }),
            showStory: ({ frames, startIndex, autoplay, interval }) => startStory({ frames, startIndex, autoplay, interval }),
            nextFrame: () => nextFrame(),
            prevFrame: () => prevFrame(),
            closeImage: () => closeImageModal('tool')
          };

          function registerNow(widget){
            try{
              if (typeof widget.setConfig === 'function') {
                widget.setConfig({ clientTools: { ...(widget.clientTools||{}), ...safeTools } });
              } else {
                widget.clientTools = { ...(widget.clientTools||{}), ...safeTools };
              }
            }catch(e){ /* noop */ }
          }

          function tryRegisterClientTools(tries=0) {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) { if (tries<40) setTimeout(()=>tryRegisterClientTools(tries+1), 250); return; }
            registerNow(widget);

            // Asegurar en cada call (por si ElevenLabs reinstancia config)
            window.addEventListener('elevenlabs-convai:call', (ev) => {
              const cfg = ev?.detail?.config || {};
              cfg.clientTools = { ...(cfg.clientTools||{}), ...safeTools };
              ev.detail.config = cfg;
            });
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryRegisterClientTools);
          } else {
            tryRegisterClientTools();
          }

          // Exponer para pruebas manuales en consola (opcional)
          window.__boriShow = openImageModal;
          window.__boriStory = startStory;
          window.__boriNext = nextFrame;
          window.__boriPrev = prevFrame;
          window.__boriClose = closeImageModal;
        })();
      </script>
    </main>

    <!-- Audio de fondo -->
    <audio id="background-audio" src="https://static.wixstatic.com/mp3/86b1c8_a1bd589ba7e547dc8a7a4cd761c40135.mp3" preload="auto"></audio>

    <!-- Karaoke + Play/Pause -->
    <script>
      (function () {
        const playPauseButton = document.getElementById("play-pause-button");
        const audio = document.getElementById("background-audio");
        const logo = document.querySelector(".header-logo");
        const lyricsContainer = document.getElementById("lyrics-container");

        const lyricsData = [
          { stanza: 0, time: 0.16, text: "Desde el balcón de Vista Pelícano," },
          { stanza: 0, time: 1.16, text: "mirando el mar azulito," },
          { stanza: 0, time: 3.03, text: "llenando la neverita desde bien tempranito." },
          { stanza: 0, time: 5.16, text: "Este vacilón tiene nombre y apellido." },
          { stanza: 1, time: 9.03, text: "Yo soy Borí Cano. Aterrizo en la Marina" },
          { stanza: 1, time: 11.22, text: "con el ferry cruzando, la brisa fresca no termina." },
          { stanza: 1, time: 13.04, text: "El sol pega duro por alante y por atrás." },
          { stanza: 2, time: 16.1, text: "Una medalla en la mano y el flow que no se va," },
          { stanza: 2, time: 18.15, text: "desde Vista Pelícano yo arranco la misión," },
          { stanza: 2, time: 21.02, text: "con la gente que me visite comienza el vacílón." },
          { stanza: 3, time: 23.1, text: "La noche promete, se siente el calentón." },
          { stanza: 3, time: 25.08, text: "Puerto Rico en mi sangre y en el pico un tostón." },
          { stanza: 4, time: 27.2, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 4, time: 31.09, text: "en el ferry hacia Isleta llegando a Vista Pelicano." },
          { stanza: 4, time: 33.16, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 4, time: 35.19, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 5, time: 48.02, text: "Llegamos a Fajardo, Harbor Café encendío'," },
          { stanza: 5, time: 50.14, text: "mofongo en la mesa, el corillo prendío'." },
          { stanza: 5, time: 53.05, text: "Risa tras risa, botella tras botella," },
          { stanza: 5, time: 55.23, text: "La Medalla brilla más, que en el cielo una estrella." },
          { stanza: 6, time: 62.18, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 6, time: 65.15, text: "hacia la playa de Icacos comienza el jangueo temprano." },
          { stanza: 6, time: 69.23, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 6, time: 73.16, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 7, time: 79.06, text: "La música sube, la islita reventá'," },
          { stanza: 7, time: 81.18, text: "dembow en las bocinas, la gente conectá'." },
          { stanza: 7, time: 83.02, text: "Yo, un pelícano con flow, represento mi bandera," },
          { stanza: 7, time: 85.23, text: "aquí no hay espacio para cervezas de tercera." },
          { stanza: 8, time: 97.2, text: "Aquí el Borí Cano con la Medalla siempre en mano," },
          { stanza: 8, time: 100.17, text: "desde Isleta Marina hasta el confín borincano." },
          { stanza: 8, time: 103.22, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 8, time: 107.22, text: "¡Borí Cano con la Medalla, orgullo de Borinquen en las entrañas!" },
          { stanza: 9, time: 112.0, text: "" }
        ];

        let currentLyricIndex = -1;

        function updateLyrics() {
          const currentTime = audio.currentTime;
          let newLyricIndex = -1;
          for (let i = 0; i < lyricsData.length; i++) {
            if (currentTime >= lyricsData[i].time) newLyricIndex = i;
            else break;
          }
          if (newLyricIndex !== currentLyricIndex) {
            currentLyricIndex = newLyricIndex;
            lyricsContainer.innerHTML = "";
            if (currentLyricIndex < 0) return;

            const make = (line, active) => {
              const p = document.createElement("p");
              p.textContent = line.text;
              p.className = "lyric-line" + (active ? " active" : "");
              return p;
            };
            const cur = lyricsData[currentLyricIndex];
            if (cur && cur.text) {
              lyricsContainer.appendChild(make(cur, true));
              const next = lyricsData[currentLyricIndex + 1];
              if (next && next.stanza === cur.stanza && next.text)
                lyricsContainer.appendChild(make(next, false));
            }
          }
        }

        if (playPauseButton && audio && logo && lyricsContainer) {
          const playIconSVG  = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
          const pauseIconSVG = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

          playPauseButton.innerHTML = playIconSVG;

          const togglePlayPause = () => {
            if (audio.paused) {
              audio.play().catch((err) => console.error("Audio error:", err));
              playPauseButton.innerHTML = pauseIconSVG;
              playPauseButton.classList.add("playing");
              playPauseButton.setAttribute("aria-label", "Pausar música");
              logo.classList.add("pulsing");
              lyricsContainer.classList.add("visible");
            } else {
              audio.pause();
              playPauseButton.innerHTML = playIconSVG;
              playPauseButton.classList.remove("playing");
              playPauseButton.setAttribute("aria-label", "Reproducir música");
              logo.classList.remove("pulsing");
              lyricsContainer.classList.remove("visible");
            }
          };

          playPauseButton.addEventListener("click", togglePlayPause);
          audio.addEventListener("timeupdate", updateLyrics);
          audio.addEventListener("ended", () => {
            playPauseButton.innerHTML = playIconSVG;
            playPauseButton.classList.remove("playing");
            playPauseButton.setAttribute("aria-label", "Reproducir música");
            audio.currentTime = 0;
            logo.classList.remove("pulsing");
            lyricsContainer.classList.remove("visible");
            lyricsContainer.innerHTML = "";
            currentLyricIndex = -1;
          });
        }
      })();
    </script>

    <div class="version-label">V3.6.1</div>
  </body>
</html>
