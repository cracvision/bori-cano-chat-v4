<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>

    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <!-- Header -->
    <header class="app-header">
      <div class="header-left">
        <button id="play-pause-button" class="audio-button" aria-label="Reproducir música"></button>
        <img src="https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png" alt="Logo de Borí Cano" class="header-logo" />
      </div>
      <div class="title-container">
        <h1>Borí Cano Chat</h1>
        <p>¡Wepa panita!</p>
      </div>
    </header>

    <!-- Karaoke -->
    <div id="lyrics-container"></div>

    <main>
      <!-- ElevenLabs widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <!-- Client Tool: SOLO modal embebido (sin popups) -->
      <script>
        (() => {
          // --- Constantes del mapa ---
          const LAT = 18.340183178224542;
          const LNG = -65.61933532856209;
          const ZOOM = 18;
          const BASEMAP = "satellite"; // "satellite" | "roadmap"

          // Plataformas
          const UA = navigator.userAgent || "";
          const isIOS = /iPad|iPhone|iPod/.test(UA);
          const isAndroid = /Android/.test(UA);

          // URLs
          const embedUrl = (() => {
            const t = BASEMAP === "satellite" ? "k" : "m";
            return `https://www.google.com/maps?q=${LAT},${LNG}&t=${t}&z=${ZOOM}&output=embed&hl=es`;
          })();

          const universalWeb = `https://maps.google.com/?q=${LAT},${LNG}&z=${ZOOM}`;
          const gmapsApp    = `comgooglemaps://?q=${LAT},${LNG}&center=${LAT},${LNG}&zoom=${ZOOM}`;
          const appleMaps   = `maps://?q=${LAT},${LNG}&z=${ZOOM}`;
          const geoAndroid  = `geo:${LAT},${LNG}?q=${LAT},${LNG}(Isleta%20Marina)&z=${ZOOM}`;

          // Crea o reutiliza <dialog> (sin abrir pestañas)
          function openMapDialog() {
            const supportsDialog = typeof HTMLDialogElement !== "undefined";
            let dlg = document.getElementById("map-dialog");
            let overlay;

            if (!dlg) {
              if (supportsDialog) {
                dlg = document.createElement("dialog");
                dlg.id = "map-dialog";
                dlg.style.cssText =
                  "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;padding:0;overflow:hidden;background:#0b0b15;";
                document.body.appendChild(dlg);
              } else {
                // Fallback overlay si <dialog> no existe
                overlay = document.createElement("div");
                overlay.id = "map-overlay";
                overlay.style.cssText =
                  "position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:16px;";
                document.body.appendChild(overlay);

                dlg = document.createElement("div");
                dlg.id = "map-dialog";
                dlg.style.cssText =
                  "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;overflow:hidden;background:#0b0b15;box-shadow:0 10px 40px rgba(0,0,0,.35);";
                overlay.appendChild(dlg);

                overlay.addEventListener("click", (e) => {
                  if (e.target === overlay) overlay.remove();
                });
              }

              const header = document.createElement("div");
              header.style.cssText =
                "display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#141428;color:#fff;font-family:Poppins,system-ui,sans-serif";
              header.innerHTML = `
                <div style="font-weight:700;font-size:14px">Mapa – Isleta Marina</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <a id="btn-open-gmaps"  style="text-decoration:none;background:#5F2EEA;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px">Abrir en Google Maps</a>
                  ${isIOS ? '<a id="btn-open-apple"  style="text-decoration:none;background:#2a7; color:#fff;padding:8px 10px;border-radius:10px;font-size:12px">Abrir en Apple Maps</a>' : ''}
                  ${isAndroid ? '<a id="btn-open-geo"    style="text-decoration:none;background:#2a7; color:#fff;padding:8px 10px;border-radius:10px;font-size:12px">Abrir en app de Mapas</a>' : ''}
                  <button id="map-close"  style="background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px">Cerrar</button>
                </div>
              `;

              const iframe = document.createElement("iframe");
              iframe.id = "map-iframe";
              iframe.style.cssText = "width:100%;height:calc(100% - 44px);border:0;";
              iframe.setAttribute("allowfullscreen", "");
              iframe.setAttribute("referrerpolicy", "no-referrer-when-downgrade");

              dlg.appendChild(header);
              dlg.appendChild(iframe);

              // Cerrar
              header.querySelector("#map-close").onclick = () => {
                if (supportsDialog) dlg.close("user");
                else document.getElementById("map-overlay")?.remove();
              };

              // Deep-links: SIEMPRE requieren toque del usuario (no programático)
              const $gm = header.querySelector("#btn-open-gmaps");
              $gm.href = universalWeb;   // universal link que suele ofrecer abrir app
              $gm.target = "_blank";
              $gm.rel = "noopener noreferrer";

              if (isIOS) {
                const $ap = header.querySelector("#btn-open-apple");
                $ap.href = appleMaps;     // Apple Maps app
                $ap.target = "_self";
              }
              if (isAndroid) {
                const $geo = header.querySelector("#btn-open-geo");
                $geo.href = geoAndroid;   // geo: intent para app nativa
                $geo.target = "_self";
              }
            }

            dlg.querySelector("#map-iframe").src = embedUrl;
            if (typeof dlg.showModal === "function" && !dlg.open) dlg.showModal();
            else if (document.getElementById("map-overlay"))
              document.getElementById("map-overlay").style.display = "flex";

            return { ok: true };
          }

          // Debug
          window.addEventListener("elevenlabs-convai:call", (e) => {
            console.log("[convai:call] detail =", e.detail);
          });

          // Registrar UN solo client tool para evitar ambigüedades del agente
          window.addEventListener("elevenlabs-convai:call", (event) => {
            const cfg = event.detail?.config || {};
            cfg.clientTools = {
              // ✅ ÚNICO TOOL: abre modal embebido (sin popups)
              openIsletaMapEmbed: () => openMapDialog()
            };
            event.detail.config = cfg;
          });
        })();
      </script>
    </main>

    <!-- Audio -->
    <audio id="background-audio" src="https://static.wixstatic.com/mp3/86b1c8_a1bd589ba7e547dc8a7a4cd761c40135.mp3" preload="auto"></audio>

    <!-- Karaoke + Play/Pause -->
    <script>
      (function () {
        const playPauseButton = document.getElementById("play-pause-button");
        const audio = document.getElementById("background-audio");
        const logo = document.querySelector(".header-logo");
        const lyricsContainer = document.getElementById("lyrics-container");

        const lyricsData = [
          { stanza: 0, time: 0.16, text: "Desde el balcón de Vista Pelícano," },
          { stanza: 0, time: 1.16, text: "mirando el mar azulito," },
          { stanza: 0, time: 3.03, text: "llenando la neverita desde bien tempranito." },
          { stanza: 0, time: 5.16, text: "Este vacilón tiene nombre y apellido." },
          { stanza: 1, time: 9.03, text: "Yo soy Borí Cano. Aterrizo en la Marina" },
          { stanza: 1, time: 11.22, text: "con el ferry cruzando, la brisa fresca no termina." },
          { stanza: 1, time: 13.04, text: "El sol pega duro por alante y por atrás." },
          { stanza: 2, time: 16.1, text: "Una medalla en la mano y el flow que no se va," },
          { stanza: 2, time: 18.15, text: "desde Vista Pelícano yo arranco la misión," },
          { stanza: 2, time: 21.02, text: "con la gente que me visite comienza el vacílón." },
          { stanza: 3, time: 23.1, text: "La noche promete, se siente el calentón." },
          { stanza: 3, time: 25.08, text: "Puerto Rico en mi sangre y en el pico un tostón." },
          { stanza: 4, time: 27.2, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 4, time: 31.09, text: "en el ferry hacia Isleta llegando a Vista Pelicano." },
          { stanza: 4, time: 33.16, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 4, time: 35.19, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 5, time: 48.02, text: "Llegamos a Fajardo, Harbor Café encendío'," },
          { stanza: 5, time: 50.14, text: "mofongo en la mesa, el corillo prendío'." },
          { stanza: 5, time: 53.05, text: "Risa tras risa, botella tras botella," },
          { stanza: 5, time: 55.23, text: "La Medalla brilla más, que en el cielo una estrella." },
          { stanza: 6, time: 62.18, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 6, time: 65.15, text: "hacia la playa de Icacos comienza el jangueo temprano." },
          { stanza: 6, time: 69.23, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 6, time: 73.16, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 7, time: 79.06, text: "La música sube, la islita reventá'," },
          { stanza: 7, time: 81.18, text: "dembow en las bocinas, la gente conectá'." },
          { stanza: 7, time: 83.02, text: "Yo, un pelícano con flow, represento mi bandera," },
          { stanza: 7, time: 85.23, text: "aquí no hay espacio para cervezas de tercera." },
          { stanza: 8, time: 97.2, text: "Aquí el Borí Cano con la Medalla siempre en mano," },
          { stanza: 8, time: 100.17, text: "desde Isleta Marina hasta el confín borincano." },
          { stanza: 8, time: 103.22, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 8, time: 107.22, text: "¡Borí Cano con la Medalla, orgullo de Borinquen en las entrañas!" },
          { stanza: 9, time: 112.0, text: "" },
        ];

        let currentLyricIndex = -1;

        function updateLyrics() {
          const currentTime = audio.currentTime;
          let newLyricIndex = -1;
          for (let i = 0; i < lyricsData.length; i++) {
            if (currentTime >= lyricsData[i].time) newLyricIndex = i;
            else break;
          }
          if (newLyricIndex !== currentLyricIndex) {
            currentLyricIndex = newLyricIndex;
            lyricsContainer.innerHTML = "";
            if (currentLyricIndex < 0) return;

            const make = (line, active) => {
              const p = document.createElement("p");
              p.textContent = line.text;
              p.className = "lyric-line" + (active ? " active" : "");
              return p;
            };
            const cur = lyricsData[currentLyricIndex];
            if (cur && cur.text) {
              lyricsContainer.appendChild(make(cur, true));
              const next = lyricsData[currentLyricIndex + 1];
              if (next && next.stanza === cur.stanza && next.text)
                lyricsContainer.appendChild(make(next, false));
            }
          }
        }

        if (playPauseButton && audio && logo && lyricsContainer) {
          const playIcon  = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
          const pauseIcon = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

          playPauseButton.innerHTML = playIcon;

          const togglePlayPause = () => {
            if (audio.paused) {
              audio.play().catch(err => console.error("Audio error:", err));
              playPauseButton.innerHTML = pauseIcon;
              playPauseButton.classList.add("playing");
              playPauseButton.setAttribute("aria-label", "Pausar música");
              logo.classList.add("pulsing");
              lyricsContainer.classList.add("visible");
            } else {
              audio.pause();
              playPauseButton.innerHTML = playIcon;
              playPauseButton.classList.remove("playing");
              playPauseButton.setAttribute("aria-label", "Reproducir música");
              logo.classList.remove("pulsing");
              lyricsContainer.classList.remove("visible");
            }
          };

          playPauseButton.addEventListener("click", togglePlayPause);
          audio.addEventListener("timeupdate", updateLyrics);
          audio.addEventListener("ended", () => {
            playPauseButton.innerHTML = playIcon;
            playPauseButton.classList.remove("playing");
            playPauseButton.setAttribute("aria-label", "Reproducir música");
            audio.currentTime = 0;
            logo.classList.remove("pulsing");
            lyricsContainer.classList.remove("visible");
            lyricsContainer.innerHTML = "";
            currentLyricIndex = -1;
          });
        }
      })();
    </script>

    <div class="version-label">V3.3.0</div>
  </body>
</html>
