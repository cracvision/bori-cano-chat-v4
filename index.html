<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>

    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      /* Estilos mínimos para los modales */
      dialog.bori-modal{
        width:min(960px,96vw);height:min(80vh,720px);
        border:none;border-radius:14px;padding:0;overflow:hidden;
        background:#0b0b15;color:#fff;box-shadow:0 10px 40px rgba(0,0,0,.35)
      }
      .bori-modal__bar{
        display:flex;align-items:center;justify-content:space-between;
        padding:10px 12px;background:#141428;font-family:Poppins,system-ui,sans-serif
      }
      .bori-modal__bar .btn{
        background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px
      }
      .bori-modal__bar .btn.primary{background:#5F2EEA}
      .bori-modal__body{height:calc(100% - 44px)}

      .karaoke-wrap{display:flex;flex-direction:column;gap:12px;height:100%;padding:16px}
      .karaoke-ctrls{display:flex;gap:8px;flex-wrap:wrap}
      .karaoke-lyrics{flex:1;overflow:auto;line-height:1.55}
      .karaoke-lyrics p{margin:0 0 8px;opacity:.85}
      .karaoke-lyrics p.active{font-weight:700;color:#E4DEFF;opacity:1}
    </style>
  </head>

  <body>
    <header class="app-header">
      <div class="title-container" style="margin-left:0">
        <h1>Borí Cano Chat</h1>
        <p>¡Wepa panita!</p>
      </div>
    </header>

    <main>
      <!-- ElevenLabs Conversational AI Widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <script>
        (function () {
          /* ========================
           *  MODAL DE IMAGEN
           * ======================== */
          function ensureImageModal () {
            let dlg = document.getElementById('img-dialog');
            if (dlg) return dlg;

            dlg = document.createElement('dialog');
            dlg.id = 'img-dialog';
            dlg.className = 'bori-modal';

            const bar = document.createElement('div');
            bar.className = 'bori-modal__bar';
            bar.innerHTML = `
              <div id="img-title" style="font-weight:700;font-size:14px">Imagen</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <a id="img-open" class="btn primary" target="_blank" rel="noopener noreferrer">Abrir</a>
                <button id="img-close" class="btn">Cerrar</button>
              </div>
            `;

            const body = document.createElement('div');
            body.className = 'bori-modal__body';
            body.innerHTML = `
              <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#0b0b15">
                <img id="img-view" style="max-width:100%;max-height:100%;object-fit:contain" alt="Imagen"/>
              </div>
              <div id="img-caption" style="padding:8px 12px;background:#0f0f1f;color:#cfd2ff;font-size:12px;font-family:Poppins,system-ui,sans-serif;"></div>
            `;

            dlg.appendChild(bar);
            dlg.appendChild(body);
            document.body.appendChild(dlg);

            dlg.querySelector('#img-close').addEventListener('click', () => dlg.close('user'));
            return dlg;
          }

          function openImageModal ({ url, title='Imagen', caption='', alt='Imagen' } = {}) {
            if (!url || typeof url !== 'string') return { ok:false, error:'missing url' };
            const dlg = ensureImageModal();
            dlg.querySelector('#img-title').textContent = title || 'Imagen';
            dlg.querySelector('#img-view').src = url;
            dlg.querySelector('#img-view').alt = alt || title || 'Imagen';
            dlg.querySelector('#img-open').href = url;
            dlg.querySelector('#img-caption').textContent = caption || '';
            if (!dlg.open && typeof dlg.showModal === 'function') dlg.showModal();
            return { ok:true, url };
          }

          /* ========================
           *  KARAOKE (modal + ctrl)
           * ======================== */
          const karaokeAudio = document.createElement('audio');
          karaokeAudio.id = 'bori-audio';
          karaokeAudio.src = 'https://static.wixstatic.com/mp3/86b1c8_a1bd589ba7e547dc8a7a4cd761c40135.mp3';
          karaokeAudio.preload = 'auto';
          document.body.appendChild(karaokeAudio);

          const lyricsData = [
            { stanza: 0, time: 0.16, text: "Desde el balcón de Vista Pelícano," },
            { stanza: 0, time: 1.16, text: "mirando el mar azulito," },
            { stanza: 0, time: 3.03, text: "llenando la neverita desde bien tempranito." },
            { stanza: 0, time: 5.16, text: "Este vacilón tiene nombre y apellido." },
            { stanza: 1, time: 9.03, text: "Yo soy Borí Cano. Aterrizo en la Marina" },
            { stanza: 1, time: 11.22, text: "con el ferry cruzando, la brisa fresca no termina." },
            { stanza: 1, time: 13.04, text: "El sol pega duro por alante y por atrás." },
            { stanza: 2, time: 16.1, text: "Una medalla en la mano y el flow que no se va," },
            { stanza: 2, time: 18.15, text: "desde Vista Pelícano yo arranco la misión," },
            { stanza: 2, time: 21.02, text: "con la gente que me visite comienza el vacílón." },
            { stanza: 3, time: 23.1, text: "La noche promete, se siente el calentón." },
            { stanza: 3, time: 25.08, text: "Puerto Rico en mi sangre y en el pico un tostón." },
            { stanza: 4, time: 27.2, text: "Aquí el Borí Cano con la medalla siempre en mano," },
            { stanza: 4, time: 31.09, text: "en el ferry hacia Isleta llegando a Vista Pelicano." },
            { stanza: 4, time: 33.16, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 4, time: 35.19, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
            { stanza: 5, time: 48.02, text: "Llegamos a Fajardo, Harbor Café encendío'," },
            { stanza: 5, time: 50.14, text: "mofongo en la mesa, el corillo prendío'." },
            { stanza: 5, time: 53.05, text: "Risa tras risa, botella tras botella," },
            { stanza: 5, time: 55.23, text: "La Medalla brilla más, que en el cielo una estrella." },
            { stanza: 6, time: 62.18, text: "Aquí el Borí Cano con la medalla siempre en mano," },
            { stanza: 6, time: 65.15, text: "hacia la playa de Icacos comienza el jangueo temprano." },
            { stanza: 6, time: 69.23, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 6, time: 73.16, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
            { stanza: 7, time: 79.06, text: "La música sube, la islita reventá'," },
            { stanza: 7, time: 81.18, text: "dembow en las bocinas, la gente conectá'." },
            { stanza: 7, time: 83.02, text: "Yo, un pelícano con flow, represento mi bandera," },
            { stanza: 7, time: 85.23, text: "aquí no hay espacio para cervezas de tercera." },
            { stanza: 8, time: 97.2, text: "Aquí el Borí Cano con la Medalla siempre en mano," },
            { stanza: 8, time: 100.17, text: "desde Isleta Marina hasta el confín borincano." },
            { stanza: 8, time: 103.22, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 8, time: 107.22, text: "¡Borí Cano con la Medalla, orgullo de Borinquen en las entrañas!" },
            { stanza: 9, time: 112.0, text: "" }
          ];

          let kDlg, kLyrics, currentLyricIdx = -1;

          function ensureKaraokeModal () {
            if (kDlg) return kDlg;
            kDlg = document.createElement('dialog');
            kDlg.id = 'karaoke-dialog';
            kDlg.className = 'bori-modal';

            const bar = document.createElement('div');
            bar.className = 'bori-modal__bar';
            bar.innerHTML = `<div style="font-weight:700;font-size:14px">Karaoke – Borí Cano</div><button id="k-close" class="btn">Cerrar</button>`;

            const body = document.createElement('div');
            body.className = 'bori-modal__body';
            body.innerHTML = `
              <div class="karaoke-wrap">
                <div class="karaoke-ctrls">
                  <button id="k-play"  class="btn">Play</button>
                  <button id="k-pause" class="btn">Pause</button>
                  <button id="k-stop"  class="btn">Stop</button>
                </div>
                <div id="k-lyrics" class="karaoke-lyrics"></div>
              </div>`;

            kDlg.appendChild(bar); kDlg.appendChild(body); document.body.appendChild(kDlg);

            kLyrics = kDlg.querySelector('#k-lyrics');
            kDlg.querySelector('#k-close').addEventListener('click', () => kDlg.close('user'));
            kDlg.querySelector('#k-play').addEventListener('click', () => karaokeAudio.play().catch(()=>{}));
            kDlg.querySelector('#k-pause').addEventListener('click', () => karaokeAudio.pause());
            kDlg.querySelector('#k-stop').addEventListener('click', () => { karaokeAudio.pause(); karaokeAudio.currentTime = 0; renderLyrics(-1); });

            karaokeAudio.addEventListener('timeupdate', () => {
              const t = karaokeAudio.currentTime; let idx = -1;
              for (let i=0;i<lyricsData.length;i++){ if (t>=lyricsData[i].time) idx=i; else break; }
              renderLyrics(idx);
            });
            karaokeAudio.addEventListener('ended', () => { karaokeAudio.currentTime = 0; renderLyrics(-1); });

            return kDlg;
          }

          function renderLyrics (idx) {
            if (idx === currentLyricIdx) return;
            currentLyricIdx = idx; kLyrics.innerHTML = '';
            if (idx < 0) return;
            const mk = (line, active) => {
              const p = document.createElement('p');
              p.textContent = line.text;
              if (active) p.classList.add('active');
              return p;
            };
            const cur = lyricsData[idx];
            if (cur && cur.text) {
              kLyrics.appendChild(mk(cur, true));
              const next = lyricsData[idx+1];
              if (next && next.stanza === cur.stanza && next.text) kLyrics.appendChild(mk(next, false));
            }
          }

          function openKaraokeModal () {
            ensureKaraokeModal();
            if (!kDlg.open && typeof kDlg.showModal === 'function') kDlg.showModal();
            return { ok:true };
          }
          function playKaraoke(){ openKaraokeModal(); return karaokeAudio.play().then(()=>({ok:true})).catch(()=>({ok:false})); }
          function pauseKaraoke(){ karaokeAudio.pause(); return { ok:true }; }
          function stopKaraoke(){ karaokeAudio.pause(); karaokeAudio.currentTime=0; renderLyrics(-1); return { ok:true }; }
          function closeKaraoke(){ if (kDlg?.open) kDlg.close('user'); return { ok:true }; }

          /* ========================
           *  REGISTRO DE CLIENT TOOLS
           * ======================== */
          const clientTools = {
            // Imagen
            showImageModal: ({ url, title, caption }) => openImageModal({ url, title, caption }),
            // Karaoke
            openKaraoke:  () => openKaraokeModal(),
            karaokeOpen:  () => openKaraokeModal(),
            startKaraoke: () => openKaraokeModal(),
            playKaraoke:  () => playKaraoke(),
            pauseKaraoke: () => pauseKaraoke(),
            stopKaraoke:  () => stopKaraoke(),
            closeKaraoke: () => closeKaraoke(),
          };

          function tryRegisterClientTools(tries=0) {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) { if (tries<30) setTimeout(()=>tryRegisterClientTools(tries+1), 250); return; }
            try {
              if (typeof widget.setConfig === 'function') {
                widget.setConfig({ clientTools: { ...(widget.clientTools||{}), ...clientTools } });
              } else {
                widget.clientTools = { ...(widget.clientTools||{}), ...clientTools };
              }
              // Fallback defensivo: asegurar en el primer call
              window.addEventListener('elevenlabs-convai:call', (ev) => {
                const cfg = ev?.detail?.config || {};
                cfg.clientTools = { ...(cfg.clientTools||{}), ...clientTools };
                ev.detail.config = cfg;
              }, { once:true });
            } catch (e) {
              if (tries<30) setTimeout(()=>tryRegisterClientTools(tries+1), 250);
            }
          }
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryRegisterClientTools);
          } else {
            tryRegisterClientTools();
          }
        })();
      </script>
    </main>

    <div class="version-label">V3.6.1</div>
  </body>
</html>
