<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <header class="app-header">
      <h1>Borí Cano Chat</h1>
      <p>¡Wepa panita!</p>
    </header>

    <main>
      <!-- ElevenLabs Conversational AI Widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <!-- Client Tool: showMap (Isleta Marina, vista satélite, popup + fallback) -->
      <script>
        (function () {
          const COORDS = "18.340183178224542,-65.61933532856209"; // Isleta Marina
          const ZOOM = "18z";

          function attachShowMapHandler() {
            const widget = document.querySelector('elevenlabs-convai');
            if (!widget) return setTimeout(attachShowMapHandler, 60);

            // Crea un mini-modal para desbloquear con click si el popup es bloqueado
            function ensureMapModal(url) {
              let modal = document.getElementById('map-modal');
              if (!modal) {
                modal = document.createElement('div');
                modal.id = 'map-modal';
                Object.assign(modal.style, {
                  position: 'fixed',
                  right: '16px',
                  bottom: '16px',
                  background: '#fff',
                  border: '1px solid #E4DEFF',
                  borderRadius: '12px',
                  boxShadow: '0 8px 30px rgba(0,0,0,.12)',
                  padding: '12px 14px',
                  fontFamily: 'Poppins, system-ui, sans-serif',
                  zIndex: 2147483647,
                  display: 'none'
                });
                modal.innerHTML = `
                  <div style="font-weight:700;margin-bottom:6px;">Abrir mapa satelital</div>
                  <div style="font-size:13px;opacity:.8;margin-bottom:10px;">
                    Tu navegador bloqueó la ventana emergente. Haz click para abrir Google Maps.
                  </div>
                  <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button id="map-dismiss" style="padding:8px 10px;border-radius:10px;border:1px solid #E4DEFF;background:#fff;cursor:pointer;">Cancelar</button>
                    <a id="map-open" style="padding:8px 12px;border-radius:10px;background:#5F2EEA;color:#fff;text-decoration:none;cursor:pointer;">Abrir mapa</a>
                  </div>
                `;
                document.body.appendChild(modal);
                modal.querySelector('#map-dismiss').onclick = () => (modal.style.display = 'none');
              }
              modal.querySelector('#map-open').setAttribute('href', url);
              modal.style.display = 'block';
              return modal;
            }

            function tryOpen(url) {
              const win = window.open(url, '_blank', 'noopener,noreferrer');
              if (win && !win.closed) return true; // popup abierto
              ensureMapModal(url);                  // fallback a botón con click del usuario
              return false;
            }

            widget.addEventListener('elevenlabs-convai:call', (event) => {
              const cfg = event?.detail?.config;
              if (!cfg) return;

              cfg.clientTools = {
                ...(cfg.clientTools || {}),
                // showMap(): abre SIEMPRE Isleta Marina en satélite
                showMap: () => {
                  const url = `https://www.google.com/maps/@${COORDS},${ZOOM}?basemap=satellite`;
                  const opened = tryOpen(url);
                  // Si en el dashboard activas "Wait for response" para pruebas,
                  // este payload regresará al agente y sabrá si fue bloqueado.
                  return {
                    ok: opened,
                    reason: opened ? 'popup-opened' : 'popup-blocked-showing-modal',
                    mapUrl: url
                  };
                }
              };
            });
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachShowMapHandler);
          } else {
            attachShowMapHandler();
          }
        })();
      </script>
    </main>

    <div class="version-label">V3.7</div>
  </body>
</html>
