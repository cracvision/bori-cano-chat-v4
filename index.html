<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>

    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <!-- Header (sin botón ni logo para que el karaoke sea sorpresa) -->
    <header class="app-header">
      <div class="title-container" style="margin-left:0">
        <h1>Borí Cano Chat</h1>
        <p>¡Wepa panita!</p>
      </div>
    </header>

    <main>
      <!-- ElevenLabs Conversational AI Widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <!-- Modales y Client Tools (mapa, imagen y karaoke) -->
      <script>
        (() => {
          /* ========================
           *  MAPA EMBEBIDO (modal)
           * ======================== */
          const DEFAULT_LAT = 18.340183178224542;
          const DEFAULT_LNG = -65.61933532856209;
          const DEFAULT_ZOOM = 18;
          const DEFAULT_BASEMAP = "satellite";

          const buildEmbedMap = ({ lat = DEFAULT_LAT, lng = DEFAULT_LNG, zoom = DEFAULT_ZOOM, basemap = DEFAULT_BASEMAP } = {}) => {
            const t = basemap === "satellite" ? "k" : "m";
            return `https://www.google.com/maps?q=${lat},${lng}&t=${t}&z=${zoom}&output=embed&hl=es`;
          };

          const buildExternalMap = ({ lat = DEFAULT_LAT, lng = DEFAULT_LNG, zoom = DEFAULT_ZOOM, basemap = DEFAULT_BASEMAP } = {}) =>
            `https://www.google.com/maps/@?api=1&map_action=map&center=${lat}%2C${lng}&zoom=${zoom}&basemap=${encodeURIComponent(basemap)}`;

          function openMapDialog({ lat = DEFAULT_LAT, lng = DEFAULT_LNG, zoom = DEFAULT_ZOOM, basemap = DEFAULT_BASEMAP, title = "Mapa – Isleta Marina" } = {}) {
            const supportsDialog = typeof HTMLDialogElement !== "undefined";
            let dlg = document.getElementById("map-dialog");
            let overlay;

            if (!dlg) {
              if (supportsDialog) {
                dlg = document.createElement("dialog");
                dlg.id = "map-dialog";
                dlg.style.cssText = "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;padding:0;overflow:hidden;background:#0b0b15;";
                document.body.appendChild(dlg);
              } else {
                overlay = document.createElement("div");
                overlay.id = "map-overlay";
                overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:16px;";
                document.body.appendChild(overlay);

                dlg = document.createElement("div");
                dlg.id = "map-dialog";
                dlg.style.cssText = "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;overflow:hidden;background:#0b0b15;box-shadow:0 10px 40px rgba(0,0,0,.35);";
                overlay.appendChild(dlg);

                overlay.addEventListener("click", (e) => {
                  if (e.target === overlay) overlay.remove();
                });
              }

              const header = document.createElement("div");
              header.style.cssText = "display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#141428;color:#fff;font-family:Poppins,system-ui,sans-serif";
              header.innerHTML = `
                <div style="font-weight:700;font-size:14px">${title}</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <a id="btn-map-open" style="text-decoration:none;background:#5F2EEA;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px">Abrir en Google Maps</a>
                  <button id="map-close" style="background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px">Cerrar</button>
                </div>
              `;

              const iframe = document.createElement("iframe");
              iframe.id = "map-iframe";
              iframe.style.cssText = "width:100%;height:calc(100% - 44px);border:0;";
              iframe.setAttribute("allowfullscreen", "");
              iframe.setAttribute("referrerpolicy", "no-referrer-when-downgrade");

              dlg.appendChild(header);
              dlg.appendChild(iframe);

              header.querySelector("#map-close").onclick = () => {
                if (supportsDialog) dlg.close("user");
                else document.getElementById("map-overlay")?.remove();
              };

              const $open = header.querySelector("#btn-map-open");
              $open.href = buildExternalMap({});
              $open.target = "_blank";
              $open.rel = "noopener noreferrer";
            }

            dlg.querySelector("#map-iframe").src = buildEmbedMap({ lat, lng, zoom, basemap });

            const a = dlg.querySelector("#btn-map-open");
            a.href = buildExternalMap({ lat, lng, zoom, basemap });

            if (typeof dlg.showModal === "function" && !dlg.open) dlg.showModal();
            else if (document.getElementById("map-overlay")) document.getElementById("map-overlay").style.display = "flex";

            return { ok: true };
          }

          /* ========================
           *  IMAGEN EMBEBIDA (modal)
           * ======================== */
          function openImageDialog({ url, title = "Vista", caption = "", alt = "Imagen" } = {}) {
            if (!url || typeof url !== "string") return { ok: false, error: "Missing image URL" };

            const supportsDialog = typeof HTMLDialogElement !== "undefined";
            let dlg = document.getElementById("img-dialog");
            let overlay;

            if (!dlg) {
              if (supportsDialog) {
                dlg = document.createElement("dialog");
                dlg.id = "img-dialog";
                dlg.style.cssText = "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;padding:0;overflow:hidden;background:#0b0b15;";
                document.body.appendChild(dlg);
              } else {
                overlay = document.createElement("div");
                overlay.id = "img-overlay";
                overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:16px;";
                document.body.appendChild(overlay);

                dlg = document.createElement("div");
                dlg.id = "img-dialog";
                dlg.style.cssText = "width:min(960px,96vw);height:min(80vh,720px);border:none;border-radius:14px;overflow:hidden;background:#0b0b15;box-shadow:0 10px 40px rgba(0,0,0,.35);";
                overlay.appendChild(dlg);

                overlay.addEventListener("click", (e) => {
                  if (e.target === overlay) overlay.remove();
                });
              }

              const header = document.createElement("div");
              header.style.cssText = "display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#141428;color:#fff;font-family:Poppins,system-ui,sans-serif";
              header.innerHTML = `
                <div id="img-title" style="font-weight:700;font-size:14px">${title}</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <a id="img-open-new" style="text-decoration:none;background:#5F2EEA;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px">Abrir imagen</a>
                  <button id="img-close" style="background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px">Cerrar</button>
                </div>
              `;

              const wrap = document.createElement("div");
              wrap.style.cssText = "display:flex;align-items:center;justify-content:center;width:100%;height:calc(100% - 76px);background:#0b0b15;";

              const img = document.createElement("img");
              img.id = "img-view";
              img.alt = alt;
              img.style.cssText = "max-width:100%;max-height:100%;object-fit:contain;display:block;";

              const cap = document.createElement("div");
              cap.id = "img-caption";
              cap.style.cssText = "padding:8px 12px;background:#0f0f1f;color:#cfd2ff;font-size:12px;font-family:Poppins,system-ui,sans-serif;";

              wrap.appendChild(img);

              dlg.appendChild(header);
              dlg.appendChild(wrap);
              dlg.appendChild(cap);

              header.querySelector("#img-close").onclick = () => {
                if (supportsDialog) dlg.close("user");
                else document.getElementById("img-overlay")?.remove();
              };
              const a = header.querySelector("#img-open-new");
              a.target = "_blank";
              a.rel = "noopener noreferrer";
            }

            dlg.querySelector("#img-title").textContent = title;
            dlg.querySelector("#img-view").src = url;
            dlg.querySelector("#img-view").alt = alt || title;
            dlg.querySelector("#img-caption").textContent = caption || "";
            dlg.querySelector("#img-open-new").href = url;

            if (typeof dlg.showModal === "function" && !dlg.open) dlg.showModal();
            else if (document.getElementById("img-overlay")) document.getElementById("img-overlay").style.display = "flex";

            return { ok: true, url };
          }

          /* ========================
           *  KARAOKE (modal + controles)
           * ======================== */
          const audio = document.createElement("audio");
          audio.id = "background-audio";
          audio.src = "https://static.wixstatic.com/mp3/86b1c8_a1bd589ba7e547dc8a7a4cd761c40135.mp3";
          audio.preload = "auto";
          document.body.appendChild(audio);

          const lyricsData = [
            { stanza: 0, time: 0.16, text: "Desde el balcón de Vista Pelícano," },
            { stanza: 0, time: 1.16, text: "mirando el mar azulito," },
            { stanza: 0, time: 3.03, text: "llenando la neverita desde bien tempranito." },
            { stanza: 0, time: 5.16, text: "Este vacilón tiene nombre y apellido." },
            { stanza: 1, time: 9.03, text: "Yo soy Borí Cano. Aterrizo en la Marina" },
            { stanza: 1, time: 11.22, text: "con el ferry cruzando, la brisa fresca no termina." },
            { stanza: 1, time: 13.04, text: "El sol pega duro por alante y por atrás." },
            { stanza: 2, time: 16.1, text: "Una medalla en la mano y el flow que no se va," },
            { stanza: 2, time: 18.15, text: "desde Vista Pelícano yo arranco la misión," },
            { stanza: 2, time: 21.02, text: "con la gente que me visite comienza el vacílón." },
            { stanza: 3, time: 23.1, text: "La noche promete, se siente el calentón." },
            { stanza: 3, time: 25.08, text: "Puerto Rico en mi sangre y en el pico un tostón." },
            { stanza: 4, time: 27.2, text: "Aquí el Borí Cano con la medalla siempre en mano," },
            { stanza: 4, time: 31.09, text: "en el ferry hacia Isleta llegando a Vista Pelicano." },
            { stanza: 4, time: 33.16, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 4, time: 35.19, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
            { stanza: 5, time: 48.02, text: "Llegamos a Fajardo, Harbor Café encendío'," },
            { stanza: 5, time: 50.14, text: "mofongo en la mesa, el corillo prendío'." },
            { stanza: 5, time: 53.05, text: "Risa tras risa, botella tras botella," },
            { stanza: 5, time: 55.23, text: "La Medalla brilla más, que en el cielo una estrella." },
            { stanza: 6, time: 62.18, text: "Aquí el Borí Cano con la medalla siempre en mano," },
            { stanza: 6, time: 65.15, text: "hacia la playa de Icacos comienza el jangueo temprano." },
            { stanza: 6, time: 69.23, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 6, time: 73.16, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
            { stanza: 7, time: 79.06, text: "La música sube, la islita reventá'," },
            { stanza: 7, time: 81.18, text: "dembow en las bocinas, la gente conectá'." },
            { stanza: 7, time: 83.02, text: "Yo, un pelícano con flow, represento mi bandera," },
            { stanza: 7, time: 85.23, text: "aquí no hay espacio para cervezas de tercera." },
            { stanza: 8, time: 97.2, text: "Aquí el Borí Cano con la Medalla siempre en mano," },
            { stanza: 8, time: 100.17, text: "desde Isleta Marina hasta el confín borincano." },
            { stanza: 8, time: 103.22, text: "El sabor de la isla, la vibra que nunca engaña," },
            { stanza: 8, time: 107.22, text: "¡Borí Cano con la Medalla, orgullo de Borinquen en las entrañas!" },
            { stanza: 9, time: 112.0, text: "" }
          ];

          const PLAY_SVG  = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M8 5v14l11-7z"/></svg>';
          const PAUSE_SVG = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
          const STOP_SVG  = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M6 6h12v12H6z"/></svg>';

          let kDlg, kOverlay, kLyrics, btnPlay, btnPause, btnStop, nudge;
          let currentLyricIndex = -1;

          function ensureKaraokeDialog() {
            if (kDlg) return;
            const supportsDialog = typeof HTMLDialogElement !== "undefined";

            if (supportsDialog) {
              kDlg = document.createElement("dialog");
              kDlg.id = "karaoke-dialog";
              kDlg.style.cssText = "width:min(900px,96vw);height:min(80vh,720px);border:none;border-radius:14px;padding:0;overflow:hidden;background:#0b0b15;";
              document.body.appendChild(kDlg);
            } else {
              kOverlay = document.createElement("div");
              kOverlay.id = "karaoke-overlay";
              kOverlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2147483647;display:flex;align-items:center;justify-content:center;padding:16px;";
              document.body.appendChild(kOverlay);

              kDlg = document.createElement("div");
              kDlg.id = "karaoke-dialog";
              kDlg.style.cssText = "width:min(900px,96vw);height:min(80vh,720px);border:none;border-radius:14px;overflow:hidden;background:#0b0b15;box-shadow:0 10px 40px rgba(0,0,0,.35);";
              kOverlay.appendChild(kDlg);

              kOverlay.addEventListener("click", (e) => {
                if (e.target === kOverlay) pauseKaraoke();
              });
            }

            const header = document.createElement("div");
            header.style.cssText = "display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#141428;color:#fff;font-family:Poppins,system-ui,sans-serif";
            header.innerHTML = `
              <div style="font-weight:700;font-size:14px">Karaoke – Borí Cano</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <button id="k-play"  style="background:#36C; color:#fff; border:0; padding:8px 10px; border-radius:10px; cursor:pointer; font-size:12px; display:flex; gap:6px; align-items:center">${PLAY_SVG}<span>Play</span></button>
                <button id="k-pause" style="background:#2a2a4a;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;display:flex;gap:6px;align-items:center">${PAUSE_SVG}<span>Pause</span></button>
                <button id="k-stop"  style="background:#8a2be2;color:#fff;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px;display:flex;gap:6px;align-items:center">${STOP_SVG}<span>Stop</span></button>
              </div>
            `;

            const body = document.createElement("div");
            body.style.cssText = "display:flex;align-items:flex-start;justify-content:center;width:100%;height:calc(100% - 56px);background:#0b0b15;padding:18px;";

            kLyrics = document.createElement("div");
            kLyrics.id = "k-lyrics";
            kLyrics.style.cssText = "max-width:780px;width:100%;height:100%;color:#fff;font-family:Poppins,system-ui,sans-serif;line-height:1.55;overflow:auto;";
            kLyrics.innerHTML = '<p style="opacity:.7">Cuando le des play, aquí se verán las líneas de la canción…</p>';

            nudge = document.createElement("div");
            nudge.id = "k-nudge";
            nudge.style.cssText = "display:none;margin-top:12px;background:#141428;color:#fff;padding:10px 12px;border-radius:10px;font-size:13px";
            nudge.innerHTML = `
              Necesitamos un toque para habilitar el audio.
              <button id="k-enable" style="margin-left:10px;background:#36C;color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer">Habilitar audio</button>
            `;

            body.appendChild(kLyrics);
            body.appendChild(nudge);

            kDlg.appendChild(header);
            kDlg.appendChild(body);

            btnPlay  = header.querySelector("#k-play");
            btnPause = header.querySelector("#k-pause");
            btnStop  = header.querySelector("#k-stop");

            btnPlay.onclick  = () => playKaraoke();
            btnPause.onclick = () => pauseKaraoke();
            btnStop.onclick  = () => stopKaraoke();

            body.querySelector("#k-enable").onclick = async () => {
              await primeAudioOnce();
              await playKaraoke();
            };
          }

          function openKaraokeDialog({ autoplay = false } = {}) {
            ensureKaraokeDialog();
            if (typeof kDlg.showModal === "function" && !kDlg.open) kDlg.showModal();
            else if (kOverlay) kOverlay.style.display = "flex";

            if (autoplay) playKaraoke();
            return { ok: true };
          }

          // ---------- Desbloqueo de audio ----------
          let primed = false;
          async function primeAudioOnce() {
            if (primed) return true;
            try {
              const wasMuted = audio.muted;
              audio.muted = true;
              await audio.play();
              audio.pause();
              audio.muted = wasMuted;
              primed = true;
              return true;
            } catch {
              primed = false;
              return false;
            }
          }

          // ---------- Letras ----------
          function resetLyrics() {
            currentLyricIndex = -1;
            if (kLyrics) kLyrics.innerHTML = "";
          }

          function updateLyrics() {
            if (!kLyrics) return;
            const t = audio.currentTime;
            let idx = -1;
            for (let i = 0; i < lyricsData.length; i++) {
              if (t >= lyricsData[i].time) idx = i; else break;
            }
            if (idx !== currentLyricIndex) {
              currentLyricIndex = idx;
              kLyrics.innerHTML = "";
              if (idx < 0) return;
              const make = (line, active) => {
                const p = document.createElement("p");
                p.textContent = line.text;
                p.style.cssText = "margin:0 0 8px";
                if (active) p.style.cssText += ";font-weight:700;color:#E4DEFF";
                else p.style.cssText += ";opacity:.8";
                return p;
              };
              const cur = lyricsData[idx];
              if (cur && cur.text) {
                kLyrics.appendChild(make(cur, true));
                const next = lyricsData[idx + 1];
                if (next && next.stanza === cur.stanza && next.text) kLyrics.appendChild(make(next, false));
              }
            }
          }

          audio.addEventListener("timeupdate", updateLyrics);
          audio.addEventListener("ended", () => { stopKaraoke(); });

          // ---------- Controles ----------
          async function playKaraoke() {
            ensureKaraokeDialog();
            const okPrime = await primeAudioOnce();
            if (!okPrime) {
              nudge.style.display = "block";
              return false;
            }
            nudge.style.display = "none";
            try {
              await audio.play();
              btnPlay.disabled = true;
              btnPause.disabled = false;
              btnStop.disabled = false;
              return true;
            } catch (e) {
              console.error("[karaoke play] error:", e);
              nudge.style.display = "block";
              return false;
            }
          }

          function pauseKaraoke() {
            audio.pause();
            btnPlay && (btnPlay.disabled = false);
            btnPause && (btnPause.disabled = true);
            return true;
          }

          function stopKaraoke() {
            audio.pause();
            audio.currentTime = 0;
            resetLyrics();
            btnPlay && (btnPlay.disabled = false);
            btnPause && (btnPause.disabled = true);
            return true;
          }

          // Exponer para client tools
          window.__boriKaraoke = { open: openKaraokeDialog, play: playKaraoke, pause: pauseKaraoke, stop: stopKaraoke };

          /* ==========================================================
           *  REGISTRO TEMPRANO DE CLIENT TOOLS + FALLBACK EN :call
           * ========================================================== */
          function getWidgetNow() {
            return document.querySelector("elevenlabs-convai");
          }
          function onWidgetReady(cb) {
            const w = getWidgetNow();
            if (w) return cb(w);
            const mo = new MutationObserver(() => {
              const w2 = getWidgetNow();
              if (w2) { mo.disconnect(); cb(w2); }
            });
            mo.observe(document.documentElement, { childList: true, subtree: true });
          }

          function toolOpenMap() {
            try { const r = openMapDialog({}); return { ok: !!r?.ok }; }
            catch (e) { console.error("[tool openIsletaMapEmbed] error:", e); return { ok: false, error: String(e) }; }
          }
          function toolShowImageModal(args = {}) {
            try { const r = openImageDialog(args); return { ok: !!r?.ok, url: r?.url || args?.url }; }
            catch (e) { console.error("[tool showImageModal] error:", e); return { ok: false, error: String(e) }; }
          }
          async function toolOpenKaraoke() {
            try { const r = window.__boriKaraoke?.open({ autoplay:false }) || { ok:true }; return { ok: !!r?.ok }; }
            catch (e) { console.error("[tool openKaraoke] error:", e); return { ok:false, error:String(e) }; }
          }
          async function toolPlayKaraoke() {
            try { window.__boriKaraoke?.open({ autoplay:false }); const ok = await window.__boriKaraoke?.play(); return { ok: !!ok }; }
            catch (e) { console.error("[tool playKaraoke] error:", e); return { ok:false, error:String(e) }; }
          }
          async function toolPauseKaraoke() {
            try { return { ok: !!window.__boriKaraoke?.pause() }; }
            catch (e) { console.error("[tool pauseKaraoke] error:", e); return { ok:false, error:String(e) }; }
          }
          async function toolStopKaraoke() {
            try { return { ok: !!window.__boriKaraoke?.stop() }; }
            catch (e) { console.error("[tool stopKaraoke] error:", e); return { ok:false, error:String(e) }; }
          }

          const tools = {
            // Map
            openIsletaMapEmbed: toolOpenMap,
            showMap: toolOpenMap, // alias

            // Image
            showImageModal: toolShowImageModal,

            // Karaoke
            openKaraoke:  toolOpenKaraoke,
            playKaraoke:  toolPlayKaraoke,
            pauseKaraoke: toolPauseKaraoke,
            stopKaraoke:  toolStopKaraoke,
          };

          // Registro temprano
          onWidgetReady((widget) => {
            widget.addEventListener("elevenlabs-convai:call", (event) => {
              const cfg = event?.detail?.config || {};
              cfg.clientTools = { ...(cfg.clientTools || {}), ...tools };
              event.detail.config = cfg;
            });
            try {
              if (typeof widget.setConfig === "function") widget.setConfig({ clientTools: tools });
            } catch {}
            console.log("[convai] clientTools registrados temprano");
          });

          // Fallback: por si llega un :call antes de que el widget esté listo
          window.addEventListener("elevenlabs-convai:call", (event) => {
            const cfg = event?.detail?.config || {};
            cfg.clientTools = { ...(cfg.clientTools || {}), ...tools };
            event.detail.config = cfg;
            console.log("[convai] clientTools inyectados en :call");
          });
        })();
      </script>
    </main>

    <div class="version-label">V3.4.0</div>
  </body>
</html>
