<script>
  // Engancha el handler en el ELEMENTO del widget (no en document).
  function attachShowMapHandler() {
    const widget = document.querySelector('elevenlabs-convai');
    if (!widget) return setTimeout(attachShowMapHandler, 60);

    const COORDS = "18.340183178224542,-65.61933532856209"; // Isleta Marina

    // Mini-modal fallback si el popup es bloqueado
    function ensureMapModal(url) {
      let modal = document.getElementById('map-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'map-modal';
        Object.assign(modal.style, {
          position: 'fixed', right: '16px', bottom: '16px', background: '#fff',
          border: '1px solid #E4DEFF', borderRadius: '12px', boxShadow: '0 8px 30px rgba(0,0,0,.12)',
          padding: '12px 14px', fontFamily: 'Poppins, system-ui, sans-serif', zIndex: 2147483647, display: 'none'
        });
        modal.innerHTML = `
          <div style="font-weight:700;margin-bottom:6px;">Abrir mapa satelital</div>
          <div style="font-size:13px;opacity:.8;margin-bottom:10px;">
            El navegador bloqueó la ventana. Haz click para abrir Google Maps.
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="map-dismiss" style="padding:8px 10px;border-radius:10px;border:1px solid #E4DEFF;background:#fff;cursor:pointer;">Cancelar</button>
            <a id="map-open" style="padding:8px 12px;border-radius:10px;background:#5F2EEA;color:#fff;text-decoration:none;cursor:pointer;">Abrir mapa</a>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelector('#map-dismiss').onclick = () => (modal.style.display = 'none');
      }
      modal.querySelector('#map-open').setAttribute('href', url);
      modal.style.display = 'block';
      return modal;
    }

    function openMap(url) {
      const win = window.open(url, '_blank', 'noopener,noreferrer');
      if (win && !win.closed) return { ok: true, via: 'popup', mapUrl: url };
      ensureMapModal(url);                  // fallback a botón (gesto de usuario)
      return { ok: false, via: 'modal', mapUrl: url };
    }

    widget.addEventListener('elevenlabs-convai:call', (event) => {
      const cfg = event?.detail?.config;
      if (!cfg) return;

      cfg.clientTools = {
        ...(cfg.clientTools || {}),
        showMap: () => {
          const url = `https://www.google.com/maps/@${COORDS},18z?basemap=satellite`;
          return openMap(url);
        }
      };
    });
  }
  // Espera a que el embed cargue
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachShowMapHandler);
  } else {
    attachShowMapHandler();
  }
</script>
