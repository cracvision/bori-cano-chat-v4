<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Borí Cano Chat</title>

    <link rel="stylesheet" href="index.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      /* ===== Modales base ===== */
      dialog.bori-modal {
        width: min(960px, 96vw);
        height: min(80vh, 720px);
        border: none;
        border-radius: 14px;
        padding: 0;
        overflow: hidden;
        background: #0b0b15;
        color: #fff;
        box-shadow: 0 10px 40px rgba(0,0,0,.35);
      }
      .bori-modal__bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #141428;
        font-family: Poppins, system-ui, sans-serif;
      }
      .bori-modal__bar .btn {
        background: #2a2a4a;
        color: #fff;
        border: 0;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 12px;
      }
      .bori-modal__bar .btn.primary { background: #5F2EEA; }
      .bori-modal__body { height: calc(100% - 44px); position: relative; }
      .bori-modal__stage {
        display: grid;
        place-items: center;
        height: 100%;
        background: #0b0b15;
      }
      .bori-modal__img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        opacity: 0;
        transition: opacity .32s ease;
      }
      .bori-modal__img.is-ready { opacity: 1; }
      .bori-modal__caption {
        padding: 8px 12px;
        background: #0f0f1f;
        color: #cfd2ff;
        font-size: 12px;
        font-family: Poppins, system-ui, sans-serif;
      }
      .hidden { display: none !important; }

      /* Header/Karaoke mínimos (tu CSS externo ya maquilla más) */
      .app-header { display:flex; align-items:center; gap:12px; padding:10px 14px; }
      .header-left { display:flex; align-items:center; gap:10px; }
      .header-logo { height: 40px; }
      .audio-button { width:36px; height:36px; border-radius:50%; border:none; cursor:pointer; }
      #lyrics-container { padding:10px 14px; min-height: 20px; }
      .lyric-line { margin: 4px 0; opacity:.6; }
      .lyric-line.active { opacity: 1; }
      .version-label { position: fixed; right: 8px; bottom: 6px; opacity: .5; font: 12px/1 Poppins,system-ui,sans-serif; }
    </style>
  </head>

  <body>
    <!-- Header -->
    <header class="app-header">
      <div class="header-left">
        <button id="play-pause-button" class="audio-button" aria-label="Reproducir música"></button>
        <img
          src="https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png"
          alt="Logo de Borí Cano"
          class="header-logo"
        />
      </div>
      <div class="title-container">
        <h1>Borí Cano Chat</h1>
        <p>¡Wepa panita!</p>
      </div>
      <div class="header-right">
        <a href="index.html" class="audio-button" aria-label="Volver a la página principal" style="display: flex; align-items: center; justify-content: center;">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
        </a>
      </div>
    </header>

    <!-- Contenedor para karaoke -->
    <div id="lyrics-container"></div>

    <main>
      <!-- ElevenLabs Conversational AI Widget -->
      <elevenlabs-convai agent-id="agent_0301k2g45tvaere8gnrgvbj9f89k"></elevenlabs-convai>
      <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>

      <!-- ===== Client Tools: showImageModal + showVideoModal ===== -->
      <script>
        (function () {
          "use strict";

          /* ---------- Constantes ---------- */
          var DEFAULT_BALCONY_MP4 =
            "https://video.wixstatic.com/video/86b1c8_84dff914082b4b9ea86d9f693b233e3c/1080p/mp4/file.mp4";

          /* ---------- Utils ---------- */
          function isHttpUrl(u){ return typeof u === "string" && /^https?:\/\//i.test(u); }
          function loadImage(url){
            return new Promise(function(resolve, reject){
              var im = new Image();
              im.onload = function(){ resolve(url); };
              im.onerror = function(){ reject(new Error("image-load-failed")); };
              im.src = url;
            });
          }

          /* ---------- IMG MODAL ---------- */
          function ensureImgModal(){
            var dlg = document.getElementById("img-dialog");
            if (dlg) return dlg;

            dlg = document.createElement("dialog");
            dlg.id = "img-dialog";
            dlg.className = "bori-modal";
            dlg.setAttribute("aria-modal", "true");

            var bar = document.createElement("div");
            bar.className = "bori-modal__bar";
            bar.innerHTML =
              '<div id="img-title" style="font-weight:700;font-size:14px">Imagen</div>' +
              '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">' +
              '  <a id="img-open" class="btn primary" target="_blank" rel="noopener noreferrer">Abrir</a>' +
              '  <button id="img-close" class="btn">Cerrar</button>' +
              "</div>";

            var body = document.createElement("div");
            body.className = "bori-modal__body";
            body.innerHTML =
              '<div class="bori-modal__stage">' +
              '  <img id="img-view" class="bori-modal__img" alt="" />' +
              "</div>" +
              '<div id="img-caption" class="bori-modal__caption hidden"></div>';

            dlg.appendChild(bar);
            dlg.appendChild(body);
            document.body.appendChild(dlg);

            dlg.querySelector("#img-close").addEventListener("click", function(){ if(dlg.open) dlg.close("user"); });
            dlg.addEventListener("cancel", function(e){ e.preventDefault(); if(dlg.open) dlg.close("esc"); });

            return dlg;
          }

          function setImgTitleAndCaption(dlg, title, caption){
            var t = dlg.querySelector("#img-title");
            var c = dlg.querySelector("#img-caption");
            t.textContent = title || "Imagen";
            c.textContent = caption || "";
            c.classList.toggle("hidden", !caption);
          }

          function openImageModal(args){
            args = args || {};
            var url = args.url || "";
            var title = args.title || "";
            var caption = args.caption || "";
            var alt = args.alt || "";

            var dlg = ensureImgModal();
            if (!dlg.open && typeof dlg.showModal === "function") dlg.showModal();

            var img = dlg.querySelector("#img-view");
            img.classList.remove("is-ready");
            if (!isHttpUrl(url)){
              // Fallback
              url = "https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png";
              title = "Imagen no disponible";
              caption = "No se pudo cargar la imagen solicitada.";
              alt = "Imagen no disponible";
            }
            loadImage(url).then(function(){
              img.src = url;
              img.alt = alt || title || "";
              dlg.querySelector("#img-open").href = url;
              setImgTitleAndCaption(dlg, title, caption);
              requestAnimationFrame(function(){ img.classList.add("is-ready"); });
            }).catch(function(){
              var fallback = "https://static.wixstatic.com/media/86b1c8_2d816491cf534b53b2b2bac9ac0a558f~mv2.png";
              img.src = fallback;
              img.alt = "Imagen no disponible";
              setImgTitleAndCaption(dlg, "Imagen no disponible", "No se pudo cargar la imagen solicitada.");
              dlg.querySelector("#img-open").href = url || "#";
              requestAnimationFrame(function(){ img.classList.add("is-ready"); });
            });

            return { ok: true, url: url };
          }

          /* ---------- VIDEO MODAL ---------- */
          function ensureVideoModal(){
            var dlg = document.getElementById("video-dialog");
            if (dlg) return dlg;

            dlg = document.createElement("dialog");
            dlg.id = "video-dialog";
            dlg.className = "bori-modal";
            dlg.setAttribute("aria-modal", "true");

            var bar = document.createElement("div");
            bar.className = "bori-modal__bar";
            bar.innerHTML =
              '<div style="font-weight:700;font-size:14px">Video</div>' +
              '<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">' +
              '  <button id="video-close" class="btn">Cerrar</button>' +
              "</div>";

            var body = document.createElement("div");
            body.className = "bori-modal__body";
            body.innerHTML =
              '<div class="bori-modal__stage">' +
              '  <video id="bori-video" controls playsinline style="max-width:100%; max-height:100%; background:#000"></video>' +
              "</div>";

            dlg.appendChild(bar);
            dlg.appendChild(body);
            document.body.appendChild(dlg);

            dlg.querySelector("#video-close").addEventListener("click", function(){ if(dlg.open) dlg.close("user"); });
            dlg.addEventListener("cancel", function(e){ e.preventDefault(); if(dlg.open) dlg.close("esc"); });

            return dlg;
          }

          function openVideoModal(args){
            args = args || {};
            var url = args.url;
            if (!isHttpUrl(url)) url = DEFAULT_BALCONY_MP4;

            var dlg = ensureVideoModal();
            var video = dlg.querySelector("#bori-video");

            // Reset sources to avoid caching previous blob
            video.pause();
            while (video.firstChild) video.removeChild(video.firstChild);

            // Si es MP4 directo
            if (/\.mp4(\?|$)/i.test(url)){
              var source = document.createElement("source");
              source.src = url;
              source.type = "video/mp4";
              video.appendChild(source);
            } else {
              // YouTube u otros -> usar iframe fallback
              var stage = dlg.querySelector(".bori-modal__stage");
              var existing = stage.querySelector("iframe");
              if (existing) existing.remove();

              var iframe = document.createElement("iframe");
              iframe.width = "100%";
              iframe.height = "100%";
              iframe.allow =
                "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
              iframe.allowFullscreen = true;
              iframe.style.border = "0";
              iframe.src = url;
              stage.appendChild(iframe);
            }

            if (!dlg.open && typeof dlg.showModal === "function") dlg.showModal();

            // Autoplay puede bloquearse; dejamos controles visibles
            video.addEventListener("canplay", function onReady(){
              video.removeEventListener("canplay", onReady);
              // No forzamos autoplay por políticas; el usuario puede darle play
            });

            return { ok: true, url: url };
          }

          /* ---------- Registro de Client Tools ---------- */
          var safeTools = {
            showImageModal: function (args){ return openImageModal(args || {}); },
            showVideoModal: function (args){ return openVideoModal(args || {}); }
          };

          function registerNow(widget){
            try{
              if (typeof widget.setConfig === "function") {
                widget.setConfig({ clientTools: Object.assign({}, widget.clientTools || {}, safeTools) });
              } else {
                widget.clientTools = Object.assign({}, widget.clientTools || {}, safeTools);
              }
            }catch(e){
              console.warn("register error", e);
            }
          }

          function tryRegisterClientTools(tries){
            tries = tries || 0;
            var widget = document.querySelector("elevenlabs-convai");
            if (!widget){
              if (tries < 40) setTimeout(function(){ tryRegisterClientTools(tries + 1); }, 250);
              return;
            }
            registerNow(widget);

            // Reinyectar en cada call (por si el widget reinstancia la config)
            window.addEventListener("elevenlabs-convai:call", function(ev){
              var cfg = (ev && ev.detail && ev.detail.config) || {};
              cfg.clientTools = Object.assign({}, cfg.clientTools || {}, safeTools);
              ev.detail.config = cfg;
            });
          }

          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", tryRegisterClientTools);
          } else {
            tryRegisterClientTools();
          }

          // Exponer helpers para pruebas manuales desde consola
          window.__boriShowImg = openImageModal;
          window.__boriShowVid = openVideoModal;
        })();
      </script>
    </main>

    <!-- Audio de fondo -->
    <audio id="background-audio" src="https://static.wixstatic.com/mp3/86b1c8_a1bd589ba7e547dc8a7a4cd761c40135.mp3" preload="auto"></audio>

    <!-- Karaoke + Play/Pause -->
    <script>
      (function () {
        "use strict";
        var playPauseButton = document.getElementById("play-pause-button");
        var audio = document.getElementById("background-audio");
        var logo = document.querySelector(".header-logo");
        var lyricsContainer = document.getElementById("lyrics-container");

        var lyricsData = [
          { stanza: 0, time: 0.16, text: "Desde el balcón de Vista Pelícano," },
          { stanza: 0, time: 1.16, text: "mirando el mar azulito," },
          { stanza: 0, time: 3.03, text: "llenando la neverita desde bien tempranito." },
          { stanza: 0, time: 5.16, text: "Este vacilón tiene nombre y apellido." },
          { stanza: 1, time: 9.03, text: "Yo soy Borí Cano. Aterrizo en la Marina" },
          { stanza: 1, time: 11.22, text: "con el ferry cruzando, la brisa fresca no termina." },
          { stanza: 1, time: 13.04, text: "El sol pega duro por alante y por atrás." },
          { stanza: 2, time: 16.1, text: "Una medalla en la mano y el flow que no se va," },
          { stanza: 2, time: 18.15, text: "desde Vista Pelícano yo arranco la misión," },
          { stanza: 2, time: 21.02, text: "con la gente que me visite comienza el vacílón." },
          { stanza: 3, time: 23.1, text: "La noche promete, se siente el calentón." },
          { stanza: 3, time: 25.08, text: "Puerto Rico en mi sangre y en el pico un tostón." },
          { stanza: 4, time: 27.2, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 4, time: 31.09, text: "en el ferry hacia Isleta llegando a Vista Pelicano." },
          { stanza: 4, time: 33.16, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 4, time: 35.19, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 5, time: 48.02, text: "Llegamos a Fajardo, Harbor Café encendío'," },
          { stanza: 5, time: 50.14, text: "mofongo en la mesa, el corillo prendío'." },
          { stanza: 5, time: 53.05, text: "Risa tras risa, botella tras botella," },
          { stanza: 5, time: 55.23, text: "La Medalla brilla más, que en el cielo una estrella." },
          { stanza: 6, time: 62.18, text: "Aquí el Borí Cano con la medalla siempre en mano," },
          { stanza: 6, time: 65.15, text: "hacia la playa de Icacos comienza el jangueo temprano." },
          { stanza: 6, time: 69.23, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 6, time: 73.16, text: "¡Borí Cano con la Medalla, orgullo borincano y no es una campaña!" },
          { stanza: 7, time: 79.06, text: "La música sube, la islita reventá'," },
          { stanza: 7, time: 81.18, text: "dembow en las bocinas, la gente conectá'." },
          { stanza: 7, time: 83.02, text: "Yo, un pelícano con flow, represento mi bandera," },
          { stanza: 7, time: 85.23, text: "aquí no hay espacio para cervezas de tercera." },
          { stanza: 8, time: 97.2, text: "Aquí el Borí Cano con la Medalla siempre en mano," },
          { stanza: 8, time: 100.17, text: "desde Isleta Marina hasta el confín borincano." },
          { stanza: 8, time: 103.22, text: "El sabor de la isla, la vibra que nunca engaña," },
          { stanza: 8, time: 107.22, text: "¡Borí Cano con la Medalla, orgullo de Borinquen en las entrañas!" },
          { stanza: 9, time: 112.0, text: "" }
        ];

        var currentLyricIndex = -1;

        function updateLyrics() {
          var currentTime = audio.currentTime;
          var newLyricIndex = -1;
          for (var i = 0; i < lyricsData.length; i++) {
            if (currentTime >= lyricsData[i].time) newLyricIndex = i;
            else break;
          }
          if (newLyricIndex !== currentLyricIndex) {
            currentLyricIndex = newLyricIndex;
            lyricsContainer.innerHTML = "";
            if (currentLyricIndex < 0) return;

            function make(line, active){
              var p = document.createElement("p");
              p.textContent = line.text;
              p.className = "lyric-line" + (active ? " active" : "");
              return p;
            }
            var cur = lyricsData[currentLyricIndex];
            if (cur && cur.text) {
              lyricsContainer.appendChild(make(cur, true));
              var next = lyricsData[currentLyricIndex + 1];
              if (next && next.stanza === cur.stanza && next.text)
                lyricsContainer.appendChild(make(next, false));
            }
          }
        }

        if (playPauseButton && audio && logo && lyricsContainer) {
          var playIconSVG  = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
          var pauseIconSVG = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';

          playPauseButton.innerHTML = playIconSVG;

          function togglePlayPause(){
            if (audio.paused) {
              audio.play().catch(function(err){ console.error("Audio error:", err); });
              playPauseButton.innerHTML = pauseIconSVG;
              playPauseButton.classList.add("playing");
              playPauseButton.setAttribute("aria-label", "Pausar música");
              logo.classList.add("pulsing");
              lyricsContainer.classList.add("visible");
            } else {
              audio.pause();
              playPauseButton.innerHTML = playIconSVG;
              playPauseButton.classList.remove("playing");
              playPauseButton.setAttribute("aria-label", "Reproducir música");
              logo.classList.remove("pulsing");
              lyricsContainer.classList.remove("visible");
            }
          }

          playPauseButton.addEventListener("click", togglePlayPause);
          audio.addEventListener("timeupdate", updateLyrics);
          audio.addEventListener("ended", function(){
            playPauseButton.innerHTML = playIconSVG;
            playPauseButton.classList.remove("playing");
            playPauseButton.setAttribute("aria-label", "Reproducir música");
            audio.currentTime = 0;
            logo.classList.remove("pulsing");
            lyricsContainer.classList.remove("visible");
            lyricsContainer.innerHTML = "";
            currentLyricIndex = -1;
          });
        }
      })();
    </script>

    <div class="version-label">V3.8.0</div>
  </body>
</html>
